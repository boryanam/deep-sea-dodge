<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Deep Sea Dodge: Graphics Overhaul</title>
    <style>
        body {
            margin: 0; display: flex; flex-direction: column; align-items: center; justify-content: center;
            height: 100vh; background-color: #000b1a; color: white; font-family: 'Segoe UI', Arial, sans-serif;
            overflow: hidden; touch-action: none;
        }
        #menu, #biome-menu {
            position: absolute; z-index: 20; background: rgba(0, 11, 26, 0.95); padding: 30px;
            border-radius: 20px; text-align: center; border: 2px solid #00ccff; width: 85%; max-width: 400px;
            box-shadow: 0 0 50px #004e92;
        }
        #biome-menu { display: none; }
        .btn-group { display: flex; flex-direction: column; gap: 10px; margin-top: 15px; }
        button { padding: 15px; font-size: 18px; font-weight: bold; cursor: pointer; border: none; border-radius: 10px; transition: 0.2s; position: relative; }
        button:active { transform: scale(0.95); }
        .best-label { display: block; font-size: 10px; opacity: 0.8; font-weight: normal; margin-top: 4px; text-transform: uppercase; letter-spacing: 1px; }
        .chill { background: #33ff57; color: #000; }
        .standard { background: #00ccff; color: #000; }
        .extreme { background: #ff4d4d; color: #fff; }
        .coral { background: #ff7f50; color: white; }
        .midnight { background: #1a1a2e; color: #999; border: 1px solid #444; }
        .volcanic { background: #8b0000; color: #ffcc00; }

        canvas { border: 4px solid #1a1a1a; border-radius: 12px; display: none; max-width: 95vw; max-height: 70vh; box-shadow: 0 0 50px rgba(0,0,0,0.5); }
        .header-ui { margin-bottom: 5px; font-size: 22px; font-weight: bold; display: none; gap: 40px; }
        #powerup-ui { color: #ffd700; font-size: 16px; min-height: 24px; font-weight: bold; text-transform: uppercase; }
    </style>
</head>
<body>

    <div id="menu">
        <h2>DEEP SEA DODGE</h2>
        <div class="btn-group">
            <button class="chill" onclick="setDiff(0.7)">CHILL</button>
            <button class="standard" onclick="setDiff(1.0)">STANDARD</button>
            <button class="extreme" onclick="setDiff(1.6)">EXTREME</button>
        </div>
    </div>

    <div id="biome-menu">
        <h2>SELECT BIOME</h2>
        <div class="btn-group">
            <button class="coral" onclick="initGame('coral')">ü™∏ CORAL REEF <span class="best-label" id="best-coral">Best: 0.0s</span></button>
            <button class="midnight" onclick="initGame('midnight')">üåë MIDNIGHT ZONE <span class="best-label" id="best-midnight">Best: 0.0s</span></button>
            <button class="volcanic" onclick="initGame('volcanic')">üåã VOLCANIC VENT <span class="best-label" id="best-volcanic">Best: 0.0s</span></button>
        </div>
    </div>

    <div class="header-ui" id="ui-top">
        <div>üåä Lvl: <span id="level">1</span></div>
        <div id="lives-display">‚ù§Ô∏è Lives: <span id="lives">3</span></div>
    </div>
    <div id="powerup-ui"></div>

    <canvas id="gameCanvas" width="850" height="450"></canvas>

    <div id="ui-bot" style="display:none; margin-top:10px; color:#a3e4ff; font-weight:bold;">
        ‚è±Ô∏è Time: <span id="timer">0.0</span>s / 60s
    </div>

    <script>
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const timerEl = document.getElementById('timer');
        const livesEl = document.getElementById('lives');
        const levelEl = document.getElementById('level');
        const powerupEl = document.getElementById('powerup-ui');

        let audioCtx, gameActive = false, animationId, difficultyMultiplier = 1.0;
        let biome = 'coral', lives = 3, currentLevel = 1, startTime = 0, invincibilityTimer = 0;
        let dashCooldown = 0, fishes = [], envParticles = [];
        const player = { x: 80, y: 225, width: 50, height: 35, speed: 7, dashing: 0 };

        function playTone(freq, type, start, duration, volume = 0.1) {
            if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            if (audioCtx.state === 'suspended') audioCtx.resume();
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.type = type; osc.frequency.setValueAtTime(freq, audioCtx.currentTime + start);
            gain.gain.setValueAtTime(volume, audioCtx.currentTime + start);
            gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + start + duration);
            osc.connect(gain); gain.connect(audioCtx.destination);
            osc.start(audioCtx.currentTime + start); osc.stop(audioCtx.currentTime + start + duration);
        }

        function setDiff(mult) {
            difficultyMultiplier = mult;
            document.getElementById('menu').style.display = 'none';
            ['coral', 'midnight', 'volcanic'].forEach(b => {
                const score = localStorage.getItem('best_' + b) || '0.0';
                document.getElementById('best-' + b).innerText = `Best: ${score}s`;
            });
            document.getElementById('biome-menu').style.display = 'block';
        }

        function initGame(selectedBiome) {
            biome = selectedBiome;
            document.getElementById('biome-menu').style.display = 'none';
            canvas.style.display = 'block';
            document.getElementById('ui-top').style.display = 'flex';
            document.getElementById('ui-bot').style.display = 'block';
            lives = 3; fishes = []; envParticles = []; currentLevel = 1; 
            invincibilityTimer = 0; dashCooldown = 0;
            livesEl.innerText = lives;
            gameActive = true; startTime = Date.now();
            
            // Seed Environment Particles
            for(let i=0; i<40; i++) envParticles.push({
                x: Math.random() * canvas.width,
                y: Math.random() * canvas.height,
                size: Math.random() * 3 + 1,
                speed: Math.random() * 1 + 0.5,
                opacity: Math.random() * 0.5 + 0.2
            });

            loop();
        }

        function resetToMenu(message, finalTime, win = false) {
            gameActive = false; cancelAnimationFrame(animationId);
            const prevBest = parseFloat(localStorage.getItem('best_' + biome) || 0);
            if (finalTime > prevBest) localStorage.setItem('best_' + biome, finalTime.toFixed(1));
            playTone(win ? 523 : 150, 'square', 0, 0.5);
            setTimeout(() => {
                alert(message);
                canvas.style.display = 'none';
                document.getElementById('ui-top').style.display = 'none';
                document.getElementById('ui-bot').style.display = 'none';
                document.getElementById('menu').style.display = 'block';
            }, 100);
        }

        const keys = {};
        window.addEventListener('keydown', e => {
            keys[e.key] = true;
            if (e.code === 'Space' && dashCooldown <= 0 && gameActive) {
                player.dashing = 15; dashCooldown = 120;
                playTone(600, 'sine', 0, 0.1, 0.2);
            }
        });
        window.addEventListener('keyup', e => keys[e.key] = false);

        canvas.addEventListener('touchmove', e => {
            if(!gameActive) return;
            const rect = canvas.getBoundingClientRect();
            let touchY = (e.touches[0].clientY - rect.top) * (canvas.height / rect.height) - 17;
            player.y = Math.max(0, Math.min(canvas.height - player.height, touchY));
        }, {passive: false});

        function createFish() {
            const r = Math.random();
            let type = (r < 0.08) ? 'bomb' : (r < 0.13) ? 'golden' : 'normal';
            const size = type === 'golden' ? 30 : (type === 'bomb' ? 45 : Math.random() * 30 + 20);
            fishes.push({
                x: canvas.width + 60, y: Math.random() * (canvas.height - size),
                width: size, height: size * 0.7, 
                speed: ((Math.random() * 2 + 2.5) + (Math.floor(((Date.now()-startTime)/1000)/20) * 0.7)) * difficultyMultiplier,
                color: type === 'golden' ? '#FFD700' : (type === 'bomb' ? '#111' : '#FF5733'),
                type, state: type === 'bomb' ? 'priming' : 'swimming', timer: 0, phase: Math.random() * 6
            });
        }

        function drawEntity(f, isPlayer = false) {
            const time = Date.now() / 1000;
            const wave = Math.sin(time * 12 + (f.phase || 0)) * 10;
            ctx.save();
            ctx.translate(f.x + f.width / 2, f.y + f.height / 2);
            if (!isPlayer) ctx.scale(-1, 1);
            
            if (f.type === 'bomb' && f.state === 'priming') {
                let p = (Math.sin(time * 25) + 1) / 2;
                ctx.shadowBlur = 15 + p * 20; ctx.shadowColor = "red";
                ctx.fillStyle = `rgb(${100 + p * 155}, 0, 0)`;
            } else if (f.type === 'golden' || (isPlayer && invincibilityTimer > 0)) {
                ctx.shadowBlur = 15; ctx.shadowColor = "yellow";
                ctx.fillStyle = isPlayer ? '#00ccff' : '#FFD700';
            } else { 
                ctx.fillStyle = isPlayer ? '#00ccff' : f.color; 
            }

            ctx.beginPath();
            ctx.moveTo(-f.width/2, 0); ctx.lineTo(-f.width/2-15, -10+wave); ctx.lineTo(-f.width/2-15, 10+wave); ctx.fill();
            ctx.beginPath(); ctx.ellipse(0, 0, f.width/2, f.height/2, 0, 0, Math.PI * 2); ctx.fill();
            
            // SPECIAL MIDNIGHT EYES
            if (biome === 'midnight' && !isPlayer) {
                ctx.shadowBlur = 10; ctx.shadowColor = "#00ffff";
                ctx.fillStyle = "#00ffff";
                ctx.beginPath(); ctx.arc(f.width/4, -f.height/6, 5, 0, 6.3); ctx.fill();
            } else {
                ctx.fillStyle = "white"; ctx.beginPath(); ctx.arc(f.width/4, -f.height/6, 4, 0, 6.3); ctx.fill();
                ctx.fillStyle = "black"; ctx.beginPath(); ctx.arc(f.width/4+1, -f.height/6, 2, 0, 6.3); ctx.fill();
            }
            ctx.restore();
            
            if (f.state === 'exploding') {
                ctx.beginPath(); ctx.arc(f.x + f.width/2, f.y + f.height/2, f.timer * 90, 0, 6.3);
                ctx.fillStyle = `rgba(255, 50, 0, ${1 - f.timer/1.5})`; ctx.fill();
            }
        }

        function drawEnvironment(time) {
            if (biome === 'coral') {
                ctx.fillStyle = '#004e92'; ctx.fillRect(0, 0, canvas.width, canvas.height);
                // God Rays
                ctx.fillStyle = "rgba(255,255,255,0.04)";
                for(let i=0; i<3; i++) {
                    let x = (Math.sin(time/2 + i)*150) + (i*300);
                    ctx.beginPath(); ctx.moveTo(x, 0); ctx.lineTo(x+120, 0); ctx.lineTo(x-80, canvas.height); ctx.fill();
                }
                // Sand
                ctx.fillStyle = '#c2b280'; ctx.fillRect(0, canvas.height - 25, canvas.width, 25);
                // Bubbles
                ctx.fillStyle = "rgba(255,255,255,0.3)";
                envParticles.forEach(p => {
                    p.y -= p.speed; if(p.y < -10) p.y = canvas.height + 10;
                    ctx.beginPath(); ctx.arc(p.x, p.y, p.size, 0, 6.3); ctx.fill();
                });
            } else if (biome === 'midnight') {
                ctx.fillStyle = '#0a1a3a'; ctx.fillRect(0, 0, canvas.width, canvas.height);
                // Marine Snow
                ctx.fillStyle = "rgba(255,255,255,0.2)";
                envParticles.forEach(p => {
                    p.y += p.speed * 0.5; p.x += Math.sin(time + p.y) * 0.2;
                    if(p.y > canvas.height) p.y = -10;
                    ctx.beginPath(); ctx.arc(p.x, p.y, p.size * 0.5, 0, 6.3); ctx.fill();
                });
            } else if (biome === 'volcanic') {
                ctx.fillStyle = '#1a0000'; ctx.fillRect(0, 0, canvas.width, canvas.height);
                // Pulse Magma
                let pulse = (Math.sin(time) + 1) * 10;
                ctx.fillStyle = `rgba(150, 0, 0, 0.15)`;
                ctx.fillRect(0, canvas.height - 40 - pulse, canvas.width, 40 + pulse);
                // Embers
                envParticles.forEach(p => {
                    p.y -= p.speed * 1.5; p.x += Math.sin(time + p.y);
                    if(p.y < -10) p.y = canvas.height + 10;
                    ctx.fillStyle = `rgba(255, ${100 + p.opacity*155}, 0, ${p.opacity})`;
                    ctx.beginPath(); ctx.arc(p.x, p.y, p.size, 0, 6.3); ctx.fill();
                });
            }
        }

        function loop() {
            if (!gameActive) return;
            const time = Date.now() / 1000;
            drawEnvironment(time);

            let elapsed = (time - startTime / 1000);
            timerEl.innerText = elapsed.toFixed(1);
            if (elapsed >= 60) { resetToMenu("VICTORY!", elapsed, true); return; }

            if (invincibilityTimer > 0) invincibilityTimer -= 1/60;
            if (dashCooldown > 0) dashCooldown--;

            let curSpd = player.speed; if (player.dashing > 0) { curSpd *= 3; player.dashing--; }
            if (keys['8'] || keys['ArrowUp']) { player.y -= curSpd; if (player.y < 0) player.y = 0; }
            if (keys['2'] || keys['ArrowDown']) { player.y += curSpd; if (player.y > canvas.height - player.height) player.y = canvas.height - player.height; }

            if (Math.random() < 0.02 + (Math.floor(elapsed/20)*0.02)) createFish();

            for (let i = fishes.length - 1; i >= 0; i--) {
                let f = fishes[i];
                if (f.state === 'priming') {
                    f.x -= f.speed; f.timer += 1/60;
                    if (f.timer >= 3) { f.state = 'exploding'; f.timer = 0; playTone(40, 'sawtooth', 0, 0.5); }
                } else if (f.state === 'swimming') { f.x -= f.speed; }
                else if (f.state === 'exploding') {
                    f.timer += 1/30;
                    let dx = (player.x+25)-(f.x+f.width/2), dy = (player.y+17)-(f.y+f.height/2);
                    if (Math.sqrt(dx*dx + dy*dy) < 140 && invincibilityTimer <= 0) { resetToMenu("KO!", elapsed); return; }
                    if (f.timer > 1.5) fishes.splice(i, 1);
                }
                let dx = (player.x+25)-(f.x+f.width/2), dy = (player.y+17)-(f.y+f.height/2);
                if (f.state !== 'exploding' && Math.sqrt(dx*dx + dy*dy) < 38) {
                    if (f.type === 'golden') { invincibilityTimer = 8; fishes.splice(i, 1); }
                    else if (invincibilityTimer <= 0) {
                        if (f.type === 'bomb') { resetToMenu("KO!", elapsed); return; }
                        lives--; livesEl.innerText = lives;
                        if (lives <= 0) { resetToMenu("GAME OVER!", elapsed); return; }
                        else { playTone(150, 'sawtooth', 0, 0.2); fishes.splice(i, 1); }
                    }
                }
                if (f.x < -100) fishes.splice(i, 1);
                drawEntity(f);
            }
            drawEntity(player, true);

            if (biome === 'midnight' && invincibilityTimer <= 0) {
                ctx.save(); ctx.globalCompositeOperation = 'destination-in';
                let grad = ctx.createRadialGradient(player.x+25, player.y+17, 0, player.x+25, player.y+17, 320);
                grad.addColorStop(0, 'rgba(0,0,0,1)'); grad.addColorStop(1, 'rgba(0,0,0,0.6)');
                ctx.fillStyle = grad; ctx.fillRect(0,0,canvas.width,canvas.height); ctx.restore();
            }
            animationId = requestAnimationFrame(loop);
        }
    </script>
</body>
</html>
